import React, {useState, useEffect, useRef, useCallback} from 'react';
import {useFocusEffect, useNavigation} from '@react-navigation/native';
import {ScrollView, Dimensions, FlatList, Platform} from 'react-native';
import styled from 'styled-components/native';
import {HeaderIcons, OtherIcons, RoutineIcons} from '../../../assets/icons';
import {themes} from '../../styles';
import dayjs from 'dayjs';
import TodayHeader from '../../components/TodayHeader';
import LinearGradient from 'react-native-linear-gradient';
import {getRoutineByDate, checkRoutine} from '../../api/routine';
// data.jsÏóêÏÑú Îç∞Ïù¥ÌÑ∞ import
import {
  timeMapping,
  initialHospitalRoutines,
  weekDays,
} from '../../../assets/data/data';
import FontSizes from '../../../assets/fonts/fontSizes';
import {getUserSchedule} from '../../api/user';
import RoutineCard from '../../components/RoutineCard';

const {width} = Dimensions.get('window');
const PAGE_SIZE = 7; // Ìïú ÌéòÏù¥ÏßÄÏóê 7ÏùºÏî© ÌëúÏãú

const Routine = () => {
  const today = dayjs();
  const flatListRef = useRef(null);
  const navigation = useNavigation();
  // ÎÇ†ÏßúÎ≥Ñ routine_medicine_idÎ•º Ï†ÄÏû•
  const [routineMedicineMap, setRoutineMedicineMap] = useState({});


  // ÌòÑÏû¨ Ï£ºÏ∞®Î•º Ï§ëÏã¨ÏúºÎ°ú Ïù¥Ï†Ñ 4Ï£º, Ïù¥ÌõÑ 4Ï£ºÍπåÏßÄ Ï¥ù 9Ï£º Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
  const generateWeeks = centerDate => {
    const weeks = [];

    // Ïù¥Ï†Ñ 4Ï£º
    for (let i = -4; i <= 4; i++) {
      const startOfWeek = centerDate.startOf('week').add(i * 7, 'day');
      const weekData = [];

      for (let j = 0; j < 7; j++) {
        const currentDate = startOfWeek.add(j, 'day');
        weekData.push({
          day: weekDays[currentDate.day()],
          date: currentDate.date(),
          month: currentDate.month() + 1,
          year: currentDate.year(),
          fullDate: currentDate,
          isToday:
            currentDate.format('YYYY-MM-DD') === today.format('YYYY-MM-DD'),
        });
      }

      weeks.push(weekData);
    }

    return weeks;
  };

  const [weeks, setWeeks] = useState(() => generateWeeks(today));
  const [currentPage, setCurrentPage] = useState(4); // ÌòÑÏû¨ Ï£ºÏ∞® Ïù∏Îç±Ïä§ (Ï§ëÏïô = 4)

  const [selectedDate, setSelectedDate] = useState({
    day: weekDays[today.day()],
    date: today.date(),
    month: today.month() + 1,
    year: today.year(),
    fullDate: today,
  });

  useFocusEffect(
    React.useCallback(() => {
      setSelectedDate({
        day: weekDays[today.day()],
        date: today.date(),
        month: today.month() + 1,
        year: today.year(),
        fullDate: today,
      });

      // Ïò§Îäò ÎÇ†ÏßúÍ∞Ä ÏûàÎäî ÌéòÏù¥ÏßÄÎ°ú Ïä§ÌÅ¨Î°§
      if (flatListRef.current) {
        flatListRef.current.scrollToIndex({
          index: 4,
          animated: true,
        });
      }
    }, []),
  );

  const [checkedItems, setCheckedItems] = useState({});

  const toggleCheck = async (medicineId, time) => {
    // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÎÇ†Ïßú Î¨∏ÏûêÏó¥
    const dateKey = selectedDate.fullDate.format('YYYY-MM-DD');
    const checkKey = `${dateKey}-${time}-${medicineId}`;
    
    // routine_medicine_id Í∞ÄÏ†∏Ïò§Í∏∞
    const routineMedicineId = routineMedicineMap[dateKey]?.[time]?.[medicineId];
    
    if (routineMedicineId) {
      setCheckedItems(prev => {
        // ÏÉàÎ°úÏö¥ Ï≤¥ÌÅ¨ ÏÉÅÌÉú Í≥ÑÏÇ∞
        const newCheckState = !prev[checkKey];
        const newState = {
          ...prev,
          [checkKey]: newCheckState,
        };
        
        // ÌÜ†Í∏ÄÎêú ÏÉÅÌÉúÍ∞íÏùÑ APIÏóê Ï†ÑÎã¨
        checkRoutine({ 
          routine_medicine_id: routineMedicineId, 
          is_taken: newCheckState 
        });
        
        console.log(`üìùÎ≥µÏö© Ïó¨Î∂Ä ÏóÖÎç∞Ïù¥Ìä∏: ${routineMedicineId} Ïùò ÏÉÅÌÉú: ${newCheckState}`);
        
        return newState;
      });
    } else {
      console.error(`routine_medicine_id not found for date: ${dateKey}, time: ${time}, medicine: ${medicineId}`);
    }
  };

  const toggleHospitalCheck = hospitalId => {
    setCheckedItems(prev => ({
      ...prev,
      [`hospital-${hospitalId}`]: !prev[`hospital-${hospitalId}`],
    }));
  };

  const toggleTimeCheck = time => {
    const dateKey = selectedDate.fullDate.format('YYYY-MM-DD');
    
    // ÌäπÏ†ï ÏãúÍ∞ÑÎåÄÏùò Î™®Îì† ÏïΩÎ¨ºÏù¥ Ï≤¥ÌÅ¨ÎêòÏóàÎäîÏßÄ ÌôïÏù∏
    const medicinesForTime = medicineRoutines.filter(
      medicine =>
        medicine.types.includes(time) &&
        medicine.day_of_weeks.includes(selectedDate.fullDate.day() === 0 ? 7 : 
        selectedDate.fullDate.day()),
    );
  
    const allChecked =
      medicinesForTime.length > 0 &&
      medicinesForTime.every(
        medicine => checkedItems[`${dateKey}-${time}-${medicine.medicine_id}`],
      );
  
    // Ìï¥Îãπ ÏãúÍ∞ÑÎåÄÏùò Î™®Îì† ÏïΩÎ¨º Ï≤¥ÌÅ¨ ÏÉÅÌÉúÎ•º Î≥ÄÍ≤Ω
    const updatedChecks = {...checkedItems};
    medicinesForTime.forEach(medicine => {
      const checkKey = `${dateKey}-${time}-${medicine.medicine_id}`;
      updatedChecks[checkKey] = !allChecked;
      
      const routineMedicineId = routineMedicineMap[dateKey]?.[time]?.[medicine.medicine_id];
      if (routineMedicineId) {
        {/* ÌïúÎ≤àÏóê Î™®Îì† ÏïΩÎ¨º Î≥µÏö© Ï≤¥ÌÅ¨ Î≥ÄÍ≤ΩÌïòÍ∏∞ Î°úÏßÅ Ï∂îÍ∞Ä */}
        // ÏòàÏãú: updateMedicineStatus(routineMedicineId, !allChecked);
        // console.log(`Update routine_medicine_id: ${routineMedicineId} to status: ${!allChecked}`);
      }
    });
  
    setCheckedItems(updatedChecks);
  };

  // Ïª¥Ìè¨ÎÑåÌä∏ ÎßàÏö¥Ìä∏ Ïãú ÏÇ¨Ïö©Ïûê ÏùºÏ†ï Í∞ÄÏ†∏Ïò§Í∏∞
  useEffect(() => {
    const fetchUserSchedule = async () => {
      try {
        const getData = await getUserSchedule();
        const scheduleData = getData.data;
        console.log('ÏÇ¨Ïö©Ïûê Î£®Ìã¥ Îç∞Ïù¥ÌÑ∞:', scheduleData);
      } catch (error) {
        console.error('ÏÇ¨Ïö©Ïûê ÏùºÏ†ï Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', error);
      }
    };

    fetchUserSchedule();
  }, []);

  const [medicineRoutines, setMedicineRoutines] = useState([]);
  //ÏûÑÏãú Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
  const [hospitalRoutines, setHospitalRoutines] = useState(
    initialHospitalRoutines,
  );

  useFocusEffect(
    useCallback(() => {
      const fetchRoutineData = async () => {
        try {
          const startDate = selectedDate.fullDate.startOf('week').format('YYYY-MM-DD');
          const endDate = selectedDate.fullDate.endOf('week').format('YYYY-MM-DD');
  
          console.log('API ÏöîÏ≤≠ ÌååÎùºÎØ∏ÌÑ∞:', { start_date: startDate, end_date: endDate });
  
          const response = await getRoutineByDate(startDate, endDate);
          const routineData = response.data.body;
          console.log('Î£®Ìã¥ Îç∞Ïù¥ÌÑ∞ ÏùëÎãµ:', routineData);
  
          const processedRoutines = processRoutineData(routineData);
          setMedicineRoutines(processedRoutines);
  
          const { routineMap, checkedMap } = mapRoutineData(routineData);
          setRoutineMedicineMap(routineMap);
          setCheckedItems(checkedMap);
  
        } catch (error) {
          console.error('Î£®Ìã¥ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', error);
        }
      };
  
      fetchRoutineData();
    }, [selectedDate.fullDate])
  );
  
  const mapRoutineData = (routineData) => {
    const routineMap = {};
    const checkedMap = {};
  
    routineData.forEach(day => {
      const dateKey = day.take_date;
      routineMap[dateKey] = {};
  
      day.user_schedule_dtos.forEach(schedule => {
        const timeType = getTimeTypeFromScheduleName(schedule.name) || getTimeTypeFromTime(schedule.take_time);
  
        if (!routineMap[dateKey][timeType]) {
          routineMap[dateKey][timeType] = {};
        }
  
        schedule.routine_medicine_dtos?.forEach(medicine => {
          const checkKey = `${dateKey}-${timeType}-${medicine.medicine_id}`;
          routineMap[dateKey][timeType][medicine.medicine_id] = medicine.routine_medicine_id;
          checkedMap[checkKey] = medicine.is_taken;
        });
      });
    });
  
    return { routineMap, checkedMap };
  };

  const getTimeTypeFromScheduleName = scheduleName => {
    const lowerName = scheduleName.toLowerCase();
  
    if (lowerName.includes('ÏïÑÏπ®')) return 'MORNING';
    if (lowerName.includes('Ï†êÏã¨')) return 'LUNCH';
    if (lowerName.includes('Ï†ÄÎÖÅ')) return 'DINNER';
    if (lowerName.includes('Ï∑®Ïπ®') || lowerName.includes('ÏûêÍ∏∞ Ï†Ñ')) return 'BEDTIME';
  
    return null;
  };  

  // Î£®Ìã¥ Îç∞Ïù¥ÌÑ∞Î•º ÏõêÌïòÎäî ÌòïÏãùÏúºÎ°ú Í∞ÄÍ≥µÌïòÎäî Ìï®Ïàò
  const processRoutineData = routineData => {
    // ÏïΩÎ¨º ID Í∏∞Ï§ÄÏúºÎ°ú Îç∞Ïù¥ÌÑ∞Î•º Í∑∏Î£πÌôîÌï† Í∞ùÏ≤¥
    const medicineMap = {};

    // ÏöîÏùº Îß§Ìïë (API ÎÇ†Ïßú -> ÏöîÏùº Ïà´ÏûêÎ°ú Î≥ÄÌôò)
    // getDayOfWeek Ìï®Ïàò ÏàòÏ†ï - ÏãúÍ∞ÑÎåÄ Ïù¥Ïäà Î∞©ÏßÄ
    const getDayOfWeek = dateString => {
      // ÎÇ†Ïßú Î¨∏ÏûêÏó¥Ïóê ÏãúÍ∞ÑÏùÑ Î™ÖÏãúÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÌïòÏó¨ ÏãúÍ∞ÑÎåÄ Ïù¥Ïäà Î∞©ÏßÄ
      const date = new Date(`${dateString}T12:00:00`);
      console.log('ÎÇ†Ïßú:', dateString, 'ÏöîÏùº:', date.getDay());
      // ÏöîÏùºÏùÑ 0(Ïùº)~6(ÌÜ†)ÏóêÏÑú 1(Ïõî)~7(Ïùº)Î°ú Î≥ÄÌôò
      return date.getDay() === 0 ? 7 : date.getDay();
    };

    // Ïä§ÏºÄÏ§Ñ Ïù¥Î¶ÑÏóê Îî∞Î•∏ ÏãúÍ∞ÑÎåÄ Îß§Ìïë
    const getTimeTypeFromScheduleName = scheduleName => {
      const lowerName = scheduleName.toLowerCase();

      if (lowerName.includes('ÏïÑÏπ®')) return 'MORNING';
      if (lowerName.includes('Ï†êÏã¨')) return 'LUNCH';
      if (lowerName.includes('Ï†ÄÎÖÅ')) return 'DINNER';
      if (lowerName.includes('Ï∑®Ïπ®') || lowerName.includes('ÏûêÍ∏∞ Ï†Ñ'))
        return 'BEDTIME';

      // Ïù¥Î¶ÑÏúºÎ°ú ÌåêÎã®Ìï† Ïàò ÏóÜÎäî Í≤ΩÏö∞ ÏãúÍ∞ÑÏúºÎ°ú ÌåêÎã®
      return null;
    };

    // ÏãúÍ∞ÑÎåÄ Îß§Ìïë (ÏãúÍ∞Ñ -> MORNING, LUNCH, DINNER, BEDTIME)
    const getTimeTypeFromTime = timeString => {
      const hour = parseInt(timeString.split(':')[0]);

      if (hour >= 5 && hour < 10) return 'MORNING';
      if (hour >= 10 && hour < 14) return 'LUNCH';
      if (hour >= 14 && hour < 20) return 'DINNER';
      return 'BEDTIME';
    };

    // Í∞Å ÎÇ†ÏßúÎ≥ÑÎ°ú Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
    routineData.forEach(dayData => {
      const dayOfWeek = getDayOfWeek(dayData.take_date);

      // Í∞Å Ïä§ÏºÄÏ§Ñ Ï≤òÎ¶¨
      dayData.user_schedule_dtos.forEach(schedule => {
        // Ïä§ÏºÄÏ§Ñ Ïù¥Î¶ÑÏúºÎ°ú ÏãúÍ∞ÑÎåÄ Í≤∞Ï†ï, ÏóÜÏúºÎ©¥ ÏãúÍ∞ÑÏúºÎ°ú ÌåêÎã®
        const timeType =
          getTimeTypeFromScheduleName(schedule.name) ||
          getTimeTypeFromTime(schedule.take_time);

        // Ìï¥Îãπ Ïä§ÏºÄÏ§ÑÏùò ÏïΩÎ¨º Ï†ïÎ≥¥ Ï≤òÎ¶¨
        if (
          schedule.routine_medicine_dtos &&
          schedule.routine_medicine_dtos.length > 0
        ) {
          schedule.routine_medicine_dtos.forEach(medicine => {
            const medicineId = parseInt(medicine.medicine_id);

            // ÏïΩÎ¨ºÏù¥ ÎßµÏóê ÏóÜÏúºÎ©¥ Ï¥àÍ∏∞Ìôî
            if (!medicineMap[medicineId]) {
              medicineMap[medicineId] = {
                medicine_id: medicineId,
                nickname: medicine.nickname || `ÏïΩÎ¨º ${medicineId}`,
                dose: medicine.dose,
                total_quantity: 0, // APIÏóêÏÑú Ïù¥ Ï†ïÎ≥¥Î•º Ï†úÍ≥µÌïòÏßÄ ÏïäÏúºÎØÄÎ°ú Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
                day_of_weeks: [],
                types: [],
              };
            }

            // Ìï¥Îãπ ÏöîÏùº Ï∂îÍ∞Ä (Ï§ëÎ≥µ ÏóÜÏù¥)
            if (!medicineMap[medicineId].day_of_weeks.includes(dayOfWeek)) {
              medicineMap[medicineId].day_of_weeks.push(dayOfWeek);
            }

            // Ìï¥Îãπ ÏãúÍ∞ÑÎåÄ Ï∂îÍ∞Ä (Ï§ëÎ≥µ ÏóÜÏù¥)
            if (!medicineMap[medicineId].types.includes(timeType)) {
              medicineMap[medicineId].types.push(timeType);
            }
          });
        }
      });
    });

    // Í∞ùÏ≤¥Î•º Î∞∞Ïó¥Î°ú Î≥ÄÌôòÌïòÍ≥† ÏöîÏùºÍ≥º ÏãúÍ∞ÑÎåÄ Ï†ïÎ†¨
    const processedRoutines = Object.values(medicineMap).map(medicine => {
      // ÏöîÏùº Ï†ïÎ†¨ (1,2,3,...)
      medicine.day_of_weeks.sort((a, b) => a - b);

      // ÏãúÍ∞ÑÎåÄ Ï†ïÎ†¨ (MORNING, LUNCH, DINNER, BEDTIME Ïàú)
      const timeOrder = {MORNING: 0, LUNCH: 1, DINNER: 2, BEDTIME: 3};
      medicine.types.sort((a, b) => timeOrder[a] - timeOrder[b]);

      return medicine;
    });

    return processedRoutines;
  };

  // Î™®Îì† Î£®Ìã¥ (ÏïΩ Î≥µÏö© + Î≥ëÏõê Î∞©Î¨∏)ÏùÑ ÏãúÍ∞ÑÏàúÏúºÎ°ú Ï†ïÎ†¨
  const getAllRoutinesByTime = () => {
    // Ïò§Îäò ÎÇ†ÏßúÏóê Ìï¥ÎãπÌïòÎäî ÏïΩ Î≥µÏö© ÏïÑÏù¥ÌÖú ÏÉùÏÑ±
    const todayMedicineItems = [];
    const dateKey = selectedDate.fullDate.format('YYYY-MM-DD');
  
    Object.entries(timeMapping).forEach(([timeKey, timeInfo]) => {
      const medicinesForTime = medicineRoutines.filter(medicine => {
        const dayMatch = medicine.day_of_weeks.includes(
          selectedDate.fullDate.day() === 0 ? 7 : selectedDate.fullDate.day(),
        );
        return medicine.types.includes(timeKey) && dayMatch;
      });
  
      if (medicinesForTime.length > 0) {
        todayMedicineItems.push({
          id: `medicine-${timeKey}`,
          label: timeInfo.label,
          time: timeInfo.time,
          sortValue: timeInfo.sortValue,
          type: 'medicine',
          timeKey,
          medicines: medicinesForTime,
        });
      }
    });
  
    // Ïò§Îäò ÎÇ†ÏßúÏóê Ìï¥ÎãπÌïòÎäî Î≥ëÏõê Î∞©Î¨∏ ÏïÑÏù¥ÌÖú ÏÉùÏÑ±
    const todayHospitalItems = hospitalRoutines
      .filter(hospital =>
        hospital.day_of_weeks.includes(selectedDate.fullDate.day() + 1),
      )
      .map(hospital => ({
        id: `hospital-${hospital.hospital_id}`,
        label: hospital.name,
        time: hospital.specific_time,
        sortValue: hospital.sortValue,
        type: 'hospital',
        hospital,
      }));
  
    // Î™®Îì† ÏïÑÏù¥ÌÖú Ìï©ÏπòÍ≥† ÏãúÍ∞ÑÏàú Ï†ïÎ†¨
    return [...todayMedicineItems, ...todayHospitalItems].sort(
      (a, b) => a.sortValue - b.sortValue,
    );
  };

  const allRoutines = getAllRoutinesByTime();

  // ÌéòÏù¥ÏßÄ Î≥ÄÍ≤Ω Ï≤òÎ¶¨
  const onPageChange = index => {
    setCurrentPage(index);
  };

  // ÌéòÏù¥ÏßÄ Î≥ÄÍ≤Ω Í∞êÏßÄ
  const onViewableItemsChanged = useRef(({viewableItems}) => {
    if (viewableItems.length > 0) {
      setCurrentPage(viewableItems[0].index);
    }
  }).current;

  const viewabilityConfig = useRef({
    itemVisiblePercentThreshold: 50,
  }).current;

  // ÏóêÎü¨ Î∞©ÏßÄÎ•º ÏúÑÌïú Ïä§ÌÅ¨Î°§ Ïù∏Îç±Ïä§ Ï≤òÎ¶¨ Ìï®Ïàò
  const handleScrollToIndexFailed = info => {
    const wait = new Promise(resolve => setTimeout(resolve, 500));
    wait.then(() => {
      if (flatListRef.current) {
        flatListRef.current.scrollToIndex({index: info.index, animated: true});
      }
    });
  };

  // Í∞Å Ï£ºÏ∞®Î•º Î†åÎçîÎßÅÌïòÎäî Ìï®Ïàò
  const renderWeek = ({item, index}) => (
    <WeekContainer>
      {item.map((dayInfo, dayIndex) => (
        <DayBox
          key={dayIndex}
          isToday={dayInfo.isToday}
          isSelected={
            selectedDate.date === dayInfo.date &&
            selectedDate.month === dayInfo.month &&
            selectedDate.year === dayInfo.year
          }
          onPress={() => setSelectedDate(dayInfo)}>
          <DayText>{dayInfo.day}</DayText>
          <DateText isToday={dayInfo.isToday}>{dayInfo.date}</DateText>
        </DayBox>
      ))}
    </WeekContainer>
  );

  return (
    <Container>
      <Header>
        <HeaderText>Î£®Ìã¥</HeaderText>
        <ReturnButton
          onPress={() => {
            // Ïò§Îäò ÎÇ†ÏßúÎ°ú ÏÑ†ÌÉù ÎÇ†Ïßú Î≥ÄÍ≤Ω
            setSelectedDate({
              day: weekDays[today.day()],
              date: today.date(),
              month: today.month() + 1,
              year: today.year(),
              fullDate: today,
            });

            // Ïò§Îäò ÎÇ†ÏßúÍ∞Ä ÏûàÎäî ÌéòÏù¥ÏßÄ(4Î≤à Ïù∏Îç±Ïä§)Î°ú Ïä§ÌÅ¨Î°§
            if (flatListRef.current) {
              flatListRef.current.scrollToIndex({
                index: 4,
                animated: true,
              });
            }
          }}>
          <OtherIcons.return
            width={11}
            height={11}
            style={{color: themes.light.pointColor.Primary10}}
          />
          <ButtonText>ÎèåÏïÑÍ∞ÄÍ∏∞</ButtonText>
        </ReturnButton>
      </Header>

      {/* ÌéòÏù¥Ïßï Í∞ÄÎä•Ìïú DayContainer */}
      <DayContainerWrapper>
        <FlatList
          ref={flatListRef}
          data={weeks}
          renderItem={renderWeek}
          keyExtractor={(_, index) => `week-${index}`}
          horizontal
          pagingEnabled
          showsHorizontalScrollIndicator={false}
          onViewableItemsChanged={onViewableItemsChanged}
          viewabilityConfig={viewabilityConfig}
          onScrollToIndexFailed={handleScrollToIndexFailed}
          // ÏÉàÎ°ú Ï∂îÍ∞ÄÌï† prop
          getItemLayout={(data, index) => ({
            length: width,
            offset: width * index,
            index,
          })}
          // initialScrollIndex Ï†úÍ±∞
        />
      </DayContainerWrapper>
      <RoundedBox>
        <LinearGradient
          colors={['rgba(245, 245, 245, 1)', 'rgba(245, 245, 245, 0)']}
          locations={[0.75, 1]}
          style={{
            position: 'absolute',
            top: 0,
            left: 0,
            right: 0,
            zIndex: 10,
          }}>
          <TodayContainer>
            <TodayHeader today={today} selectedDate={selectedDate} />
            <MedicineListButton
              onPress={() => navigation.navigate('MedicineList')}>
              <MedicineListText>Ï†ÑÏ≤¥ Î™©Î°ù</MedicineListText>
              <HeaderIcons.chevron
                width={11}
                height={11}
                style={{
                  transform: [{rotate: '180deg'}],
                  color: themes.light.textColor.Primary50,
                }}
              />
            </MedicineListButton>
          </TodayContainer>
        </LinearGradient>

        <ScrollView contentContainerStyle={{paddingVertical: 70}}>
          <ScheduleContainer>
            {/* ÌÉÄÏûÑÎùºÏù∏ Ïª®ÌÖåÏù¥ÎÑà Ï∂îÍ∞Ä */}
            <TimelineContainer>
              {/* ÌÉÄÏûÑÎùºÏù∏ ÏÑ∏Î°úÏ§Ñ */}
              <TimelineLine />

              {/* Î™®Îì† Î£®Ìã¥ÏùÑ ÏãúÍ∞ÑÏàúÏúºÎ°ú Î†åÎçîÎßÅ */}
              {allRoutines.map((routine, index) => (
                <RoutineCard
                  key={routine.id}
                  routine={routine}
                  index={index}
                  allLength={allRoutines.length}
                  checkedItems={checkedItems}
                  toggleTimeCheck={toggleTimeCheck}
                  toggleHospitalCheck={toggleHospitalCheck}
                  toggleCheck={toggleCheck}
                  selectedDateString={selectedDate.fullDate.format('YYYY-MM-DD')}
                />
              ))}
            </TimelineContainer>
          </ScheduleContainer>
        </ScrollView>
      </RoundedBox>
    </Container>
  );
};

const Container = styled.View`
  flex: 1;
  background-color: ${themes.light.pointColor.Primary};
`;

const Header = styled.View`
  background-color: ${themes.light.pointColor.Primary};
  flex-direction: row;
  padding: 0px 20px;

  ${Platform.OS === 'ios' && `padding-top: 70px;`}
  ${Platform.OS === 'android' && `padding-top: 30px;`}
  justify-content: space-between;
`;

const HeaderText = styled.Text`
  font-size: ${FontSizes.title.default};
  font-family: 'KimjungchulGothic-Bold';
  color: ${themes.light.textColor.buttonText};
  padding-left: 10px;
`;

const ReturnButton = styled.TouchableOpacity`
  flex-direction: row;
  padding: 4px 10px;
  justify-content: center;
  align-items: center;
  gap: 7px;
  border: 1px solid ${themes.light.pointColor.Primary20};
  border-radius: 20px;
`;

const ButtonText = styled.Text`
  font-size: ${FontSizes.caption.default};
  font-family: 'Pretendart-Medium';
  color: ${themes.light.pointColor.Primary10};
`;

const MedicineListButton = styled(ReturnButton)`
  border: 1.5px solid ${themes.light.borderColor.borderPrimary};
  border-radius: 40px;
  padding: 6px 10px;
  gap: 7px;
`;

const MedicineListText = styled(ButtonText)`
  color: ${themes.light.textColor.Primary50};
  font-family: 'Pretendart-Medium';
  font-size: ${FontSizes.caption.default};
`;

// ÌéòÏù¥ÏßïÏùÑ ÏúÑÌïú Ïª®ÌÖåÏù¥ÎÑà
const DayContainerWrapper = styled.View`
  background-color: ${themes.light.pointColor.Primary};
`;

// Ï£ºÏ∞® Îã®ÏúÑ Ïª®ÌÖåÏù¥ÎÑà
const WeekContainer = styled.View`
  flex-direction: row;
  justify-content: space-around;
  width: ${width}px;
  padding: 20px 20px;
`;

const DayBox = styled.TouchableOpacity`
  flex: 1;
  align-items: center;
  display: flex;
  padding: 10px 4px;
  border-radius: 7px;
  background-color: ${({isToday, isSelected}) =>
    isSelected ? themes.light.pointColor.PrimaryDark : 'transparent'};
`;

const DayText = styled.Text`
  font-size: ${FontSizes.caption.default};
  font-family: 'Pretendard-Medium';
  color: ${themes.light.textColor.buttonText};
`;

const DateText = styled.Text`
  font-size: ${FontSizes.heading.default};
  font-family: 'Pretendard-SemiBold';
  color: ${themes.light.textColor.buttonText};
`;

const ScheduleContainer = styled.View`
  background-color: ${themes.light.bgColor.bgSecondary};
  padding-bottom: 150px;
`;

const RoundedBox = styled.View`
  border-top-left-radius: 24px;
  border-top-right-radius: 24px;
  background-color: ${themes.light.bgColor.bgSecondary};
  overflow: hidden;
  height: 100%;
`;

const TodayContainer = styled.View`
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
  padding: 20px 30px;
`;
// ÌÉÄÏûÑÎùºÏù∏ Í¥ÄÎ†® Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä
const TimelineContainer = styled.View`
  //padding-top: 10px;
  padding-left: 30px;
  position: relative;
`;

const TimelineLine = styled.View`
  position: absolute;
  left: 21px;
  top: 30px;
  bottom: 30px;
  width: 6px;
  background-color: ${themes.light.pointColor.Primary};
`;

export default Routine;
